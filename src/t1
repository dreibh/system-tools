#!/bin/bash

read -r -a allTunnelInterfaces <<< "`(ip -4 tunnel show ; ip -6 tunnel show ) | cut -d':' -f1 | sort -u | xargs`"
echo "${allTunnelInterfaces[@]}"
echo "${allTunnelInterfaces[1]}"

ip addr show | (
   interface="BAD!"
   loopback=1
   tunnel=0
   up=0
   while read line ; do
#       echo "$loopback"
      # ------ Interface name and flags -------------------------------------
      if [[ "${line}" =~ ^([0-9]+)(: )([a-zA-Z0-9\.-]+)(@[[a-zA-Z0-9\.-]+|)(: <)([^>]*)(>.*)$ ]] ; then
         interface="${BASH_REMATCH[3]}"
         flags=(${BASH_REMATCH[6]//,/ })
         if [[ " ${flags[@]} " =~ UP ]] ; then
            up=1
         else
            up=0
         fi
         if [[ " ${flags[@]} " =~ LOOPBACK ]] ; then
            loopback=1
         else
            loopback=0
         fi
         if [[ " ${allTunnelInterfaces[@]} " =~ ${interface} ]] ; then
            tunnel=1
         else
            tunnel=0
         fi
      # ------ IPv4 ---------------------------------------------------------
      elif [[ "${line}" =~ ^([ \t]*inet )([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)\/([0-9]+)( .*)$ ]] ; then
         if [ ${loopback} -eq 0 -o ${tunnel} -eq 0 ] ; then
            echo -e "${interface}\t${up}\t4\t${BASH_REMATCH[2]}\t${BASH_REMATCH[3]}"
         fi
      # ------ IPv6 ---------------------------------------------------------
      elif [[ "${line}" =~ ^([ \t]*inet6 ([0-9a-fA-F:]+)\/([0-9]+) scope [gsh])(.*)$ ]] ; then
         if [ ${loopback} -eq 0 -o ${tunnel} -eq 0 ] ; then
            echo -e "${interface}\t${up}\t6\t${BASH_REMATCH[2]}\t${BASH_REMATCH[3]}"
         fi
      # ------ Not relevant -------------------------------------------------
      # else
      #    echo "no match: ${line}"
      fi
   done
) | sort -k1,2




#    allInterfaces=`ip link show 2>/dev/null | awk '/^([0-9]*:) ([a-zA-Z0-9\-\.@]+):/ { print $2 }' | sed -e "s/@.*//" -e "s/:$//" | sort`
#    for interface in $allInterfaces ; do
#       # echo "$interface"
#       # ====== Only show non-tunnel interfaces =================================
#       if [ "`ip tunnel show $interface 2>/dev/null`" == "" -a \
#            "`ip -6 tunnel show $interface 2>/dev/null`" == "" ] ; then
#          # ====== Only show non-loopback interfaces ============================
#          if [ "`ip link show dev $interface | head -n1 | grep "^.*<.*LOOPBACK.*>"`" == "" ] ; then
#             # ====== Get status ================================================
#             isUp=0
#             if [ "`ip link show dev $interface | head -n1 | grep "^.*<.*UP.*>"`" != "" ] ; then
#                isUp=1
#             fi
#
#             # ====== Get addresses =============================================
#             addressListIPv4=`ip -4 addr show dev $interface 2>/dev/null | awk '/[ \t]*inet ([0-9]+).([0-9]+).([0-9]+).([0-9]+)\/([0-9]+) / { print $2 }' | sort`
#             addressListIPv6=`ip -6 addr show dev $interface 2>/dev/null | awk '/[ \t]*inet6 [0-9a-fA-F:]*\/[0-9]+ scope [gsh]/ { print $2 }' | sort`
#             showAddresses
#          fi
#       fi
